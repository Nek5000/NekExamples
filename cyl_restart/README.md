# Example of full restart capabilities for Nek5000.

The model flow is a von Karman street in the wake of a 2D cylinder.
The quantity of interest is taken to be the lift, which is monitored
via "grep agy logfile" in the run_test script.   A matlab file, doit.m,
can be used to analyze the output files containing the lift history
of the four cases.  The cases are:

ca   -   initial run (no projection)
cb   -   restart run for ca case

pa   -   initial run (with projection)
pb   -   restart run for pa case

## BACKGROUND:

Timestepping in Nek5000 is based on BDFk/EXTk (k=3, typ.), which uses kth-order
backward-difference formulae (BDFk) to evaluate velocity time derivatives and
kth-order extrapolation (EXTk) for explicit evaluation of the nonlinear and
pressure boundary terms.  Under normal conditions, the velocity and pressure
for preceding timesteps are required to advance the the solution at each step.

At startup, the timestepper is typically bootstrapped using a lower-order
BDF/EXT formula that, given the artificiality of most initial conditions,
is typically adequate.    The velocity field often has enough inertia and
sufficient signature such that the same bootstrap procedure also works when
restarting from an existing solution (i.e., a .fnnnnn or .fldnn file, stored
in 32-bit precision).

For some cases, it is important to have reproducibility of the time history
to the working precision (14 digits, typ.) of the code.  The full restart
feature is designed to provide this capability. The main features of 
full restart are:

.The number of saved restart files corresponds exactly to the order of time 
integration only if a negative sign is set to TORDER (or param(27)). Otherwise 
3 restart files are saved by default. Note that for the saving procedure this 
is managed automatically and do not need any file modification. However in the 
reading stage the .usr files should be updated as indicated.

.Preserve alternating sets of snapshots (1 to 3 per set depending on param(27)) 
in 64-bit precision.(Alternating sets are saved in case the job fails in the 
middle of saving a set.)

.Use the most recent set to restart the computation by overwriting
 the solution for the first steps, 0 through 3 for example, with the preserved 
 snapshots. Pay attention to the names and number of the saved restart 
files, which will differ depending on param(27).  


Full restart is triggered through the .usr file.    In the given example 
cases, "ca" and "cb" the restart-save is illustrated in ca.usr and the 
actual restart, plus the save, is illustrated in cb.usr.   For these cases, 
the restart is encapsulated in the user-provided routine "my_full_restart"
shown below, along with the calling format in userchk:


c-----------------------------------------------------------------------
      subroutine userchk
      include 'SIZE'
      include 'TOTAL'

      logical if_drag_out,if_torq_out

      call my_full_restart

      scale = 1.
      if_drag_out = .true.
      if_torq_out = .false.
      call torque_calc(scale,x0,if_drag_out,if_torq_out)

      return
      end
c-----------------------------------------------------------------------
      subroutine my_full_restart

      character*80 s80(3)

      call blank(s80,3*80)
      s80(1) ='rs8ca0.f00004'
      s80(2) ='rs8ca0.f00005'
      s80(3) ='rs8ca0.f00006'

      call full_restart(s80,3)  ! Will overload 4-6 onto steps 0-2


      iosave = iostep           ! Trigger save based on iostep
      call full_restart_save(iosave)

      return
      end
c-----------------------------------------------------------------------


Note that in the example above, the set enumerated 4--6 is used to restart 
the computation.   This set is generated by first running the "ca" case.

Note that the frequency of the restart output is coincident with the
standard output frequency of field files (snapshots).  This might be too 
frequent if one is, say, making a movie where snapshots are typically 
dumped every 10 steps.   It would make more sense in this case to set 
iosave=1000, say.

Note also that if one is initiating a computation from something other
than the full restart mode then the full_restart() call should be commented
out.

## COMMENTS:

Full reproducibility of the solution is predicated on having sufficient
history information to replicate the state of "a" when running "b".
While such replication is possible, it does preclude acceleration of the
iterative solvers by projection onto prior solution spaces [1,2], since
these projections typically retain relatively long sequences of information
(e.g., spanning tens of steps) to maximally extract all the regularity in the
solution history.   Consequently, _full_ reproducibility is not retained with
projection turned on.  In this case, the solution is reproduced only to the
tolerance of the iterative solvers, which is in any case the maximum level
of accuracy attainable in the solution.   To illustrate the difference,
we provide a test case pairing, "pa" and "pb", which is essentially the 
same as the ca/cb pair save that projection is turned on for pa/pb.


